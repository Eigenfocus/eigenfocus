#!/bin/bash -e

load_or_create_secret_env()
{
  mkdir -p ./app-data

  if ! [ -e ./app-data/secret.txt ]
  then
    echo "Creating application secret on app-data/secret.txt..."
    bundle exec rails secret > ./app-data/secret.txt
  fi

  export SECRET_KEY_BASE=$(cat ./app-data/secret.txt)
}

load_or_create_secret_env
cp config/database.example.yml config/database.yml
rm -f tmp/pids/server.pid

./bin/rails db:prepare

./bin/rails server -b 0.0.0.0