<%= turbo_frame_tag 'issue_detail' do %>
  <%= start_pending_app_tour_tag("issues/detail") %>
  <%
    data = {
      controller: "issue-detail",
      action: "modal:closed@window->issue-detail#goBackHistory",
      "issue-detail-submit-on-title-change-value": local_assigns[:submit_on_title_change],
      "issue-detail-path-for-modal-closed-value": local_assigns[:back_path]
    }
  %>

  <% data.merge!("issue-detail-attach-path-value": attach_issue_file_path(issue)) if issue.persisted? %>

  <%= render Modal::DialogComponent.new(
    hide_close_button: true,
    modal_box: {
      class: "max-w-5xl relative cpy-issue-detail p-0 flex flex-col",
      data: data,
    }) do %>

      <%= render 'issues/issue_detail/header', issue: issue %>


      <div class="flex flex-col md:flex-row items-stretch grow h-full">
        <div class="issue-detail p-4 w-full lg:w-[60%] flex flex-col">

          <div class="flex flex-row items-center flex-nowrap gap-2">
            <%= render(Issue::FinishToggleComponent.new(issue: issue, has_hover_animation: false)) %>

            <div class="flex grow">
              <%= form_with(model: issue, url: local_assigns[:form_path], html: {
                class: 'w-full flex justify-stretch',
                data: {
                  turbo: true,
                  "issue-detail-target": "form",
                  action: "turbo:submit-end->issue-detail#onFormSubmit",
                }
                }) do |f| %>

                <div data-controller='resizable-input' class="w-full cpy-issue-detail-title relative" >
                  <div data-resizable-input-target="replica" class="break-all text-xl font-bold text-base-content p-1 pt-1 -ml-2 whitespace-pre-line"></div>

                  <%= f.text_area :title, required: true,
                    class: "issue-detail-title-input -ml-2 min-h-8",
                    "data-resizable-input-target": "input",
                    "data-issue-detail-target": "titleField",
                    "data-action": "keydown.enter->issue-detail#onTitleFieldEnter keydown.esc->issue-detail#onTitleFieldEsc blur->issue-detail#onTitleFieldBlur"
                    %>
                </div>
              <% end %>
            </div>
          </div>
          <%= render partial: "issues/issue_detail/issue_finished_at", locals: { issue: } %>

          <div class="mt-4" data-controller="dropzone" data-action="dropzone:complete->issue-detail#fileUploadCompleted">

            <%= render partial: 'issues/issue_detail/main_form', locals: { issue:, form_path: local_assigns[:form_path] } %>

          </div>
        </div>

        <div class="w-full lg:w-[40%] bg-base-200/40 p-4">
          <%= render partial: 'issues/comments/comments', locals: { issue: } if issue.persisted? %>
        </div>
      </div>
    <% end %>
<% end %>
